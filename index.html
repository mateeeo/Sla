<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Handball VR - Simulador Completo</title>
<script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
</head>

<body>
<a-scene shooter>

  <!-- Chão e céu -->
  <a-plane rotation="-90 0 0" width="20" height="20" color="#f58220"></a-plane>
  <a-sky color="#222"></a-sky>

  <!-- Score -->
  <a-text id="score" value="Score: 0" position="0 3 -5" align="center" width="8" color="white"></a-text>

  <!-- Som de golo -->
  <a-sound id="goal-sound" src="https://cdn.aframe.io/basic-guide/audio/boing.mp3" autoplay="false"></a-sound>

  <!-- Câmera -->
  <a-entity position="0 1.6 5">
    <a-camera>
      <a-cursor></a-cursor>
    </a-camera>
  </a-entity>

  <!-- Baliza -->
  <a-entity id="goal" position="0 0 -10">
    <a-box position="-1.5 1 0" width="0.1" height="2" depth="0.1" color="white"></a-box>
    <a-box position="1.5 1 0" width="0.1" height="2" depth="0.1" color="white"></a-box>
    <a-box position="0 2 0" width="3" height="0.1" depth="0.1" color="white"></a-box>
    <!-- Trigger invisível -->
    <a-box id="goal-trigger" position="0 1 -0.5" width="3" height="2" depth="0.5" visible="false" goal></a-box>
  </a-entity>

  <!-- Guarda-redes -->
  <a-box id="keeper" position="0 1 -9.3" width="0.7" height="1.6" depth="0.3" color="red"
         animation="property: position; from: -1.2 1 -9.3; to: 1.2 1 -9.3; dir: alternate; loop: true; dur: 1500">
  </a-box>

</a-scene>

<script>
let score = 0;

// DETECTOR DE GOLO
AFRAME.registerComponent('goal', {
  init() {
    this.el.addEventListener('check-collision', e => {
      const bola = e.detail.bola;
      if (!bola) return;

      const p = bola.object3D.position;
      const b = this.el.object3D;

      // Detecta colisão com baliza
      if (p.x > b.position.x - 1.5 && p.x < b.position.x + 1.5 &&
          p.y > b.position.y - 1 && p.y < b.position.y + 1 &&
          p.z > b.position.z - 0.5 && p.z < b.position.z + 0.5) {

        // Verifica se o guarda-redes bloqueia
        const keeper = document.querySelector('#keeper');
        const kp = keeper.object3D.position;
        if (Math.abs(p.x - kp.x) < 0.4 && Math.abs(p.y - kp.y) < 1) {
          // Bola bloqueada
          bola.remove();
          return;
        }

        score++;
        document.querySelector('#score').setAttribute('value', 'Score: ' + score);

        // Som de golo
        const sound = document.querySelector('#goal-sound');
        sound.components.sound.playSound();

        bola.remove();
      }
    });
  }
});

// SHOOTER COM FORÇA PROGRESSIVA
AFRAME.registerComponent('shooter', {
  init() {
    const scene = this.el;
    let power = 0;
    let charging = false;
    let interval;

    const maxPower = 1.5;

    window.addEventListener('keydown', e => {
      if (e.code === 'Space' && !charging) {
        charging = true;
        power = 0;
        interval = setInterval(() => {
          power += 0.02;
          if (power > maxPower) power = maxPower;
        }, 16);
      }
    });

    window.addEventListener('keyup', e => {
      if (e.code === 'Space' && charging) {
        charging = false;
        clearInterval(interval);

        const cam = document.querySelector('[camera]');
        const bola = document.createElement('a-sphere');
        bola.setAttribute('radius', 0.15);
        bola.setAttribute('color', '#4CC3D9');
        scene.appendChild(bola);

        // Posição inicial
        const pos = new THREE.Vector3();
        cam.object3D.getWorldPosition(pos);
        bola.object3D.position.copy(pos);

        // Direção
        const dir = new THREE.Vector3(0,0,-1);
        dir.applyQuaternion(cam.object3D.quaternion);

        // Velocidade proporcional ao power
        let velocity = { x: dir.x * 5 * power, y: dir.y * 5 * power + power*2, z: dir.z * 5 * power };

        bola.setAttribute('movement', { vel: velocity });

        // Checa colisão com baliza
        const goalTrigger = document.querySelector('#goal-trigger');
        const check = () => {
          if (!bola.parentNode) return;
          goalTrigger.emit('check-collision', { bola: bola });
          requestAnimationFrame(check);
        };
        check();

        // Limpeza
        setTimeout(() => {
          if (bola.parentNode) bola.parentNode.removeChild(bola);
        }, 5000);
      }
    });
  }
});

// MOVIMENTO DA BOLA (Gravidade manual)
AFRAME.registerComponent('movement', {
  schema: { vel: { type: 'vec3' } },

  tick(time, delta) {
    const dt = delta / 1000;
    const v = this.data.vel;

    // gravidade
    v.y -= 9.8 * dt;

    const p = this.el.object3D.position;
    p.x += v.x * dt;
    p.y += v.y * dt;
    p.z += v.z * dt;

    // chão
    if (p.y < 0.2) {
      p.y = 0.2;
      v.y *= -0.5;
      v.x *= 0.8;
      v.z *= 0.8;
    }
  }
});
</script>
</body>
</html>
