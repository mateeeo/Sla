<!DOCTYPE html>
<html>
  <head>
    <title>Andebol VR - Fixed</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <!-- Essential: Added the physics engine library -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.7.1/dist/aframe-master.min.js"></script>
  </head>
  <body>
    <a-scene physics="debug: false; gravity: -9.8" shooter vr-mode-ui="enabled: true">
      
      <a-sky color="#222"></a-sky>
      <a-plane static-body rotation="-90 0 0" width="50" height="50" color="#f58220"></a-plane>

      <!-- BALIZA (Now correctly positioned at Z = -10) -->
      
        <a-box static-body position="-1.5 1 0" width="0.1" height="2" depth="0.1" color="white"></a-box>
        <a-box static-body position="1.5 1 0" width="0.1" height="2" depth="0.1" color="white"></a-box>
        <a-box static-body position="0 2 0" width="3.1" height="0.1" depth="0.1" color="white"></a-box>
        <!-- Invisible back wall to stop the ball -->
        <a-plane static-body position="0 1 -0.1" width="3" height="2" opacity="0.1" color="white"></a-plane>
      

      <!-- GUARDA-REDES -->
      <a-box id="keeper"
             static-body
             position="0 0.8 -9.7" 
             width="0.8" height="1.6" depth="0.3" 
             color="red"
             animation="property: position; to: 1.1 0.8 -9.7; from: -1.1 0.8 -9.7; dur: 1500; dir: alternate; loop: true; easing: linear">
      </a-box>

      <!-- Camera + Crosshair -->
      
        
        
      

    </a-scene>

    <script>
      AFRAME.registerComponent('shooter', {
        init: function () {
          const cena = this.el;
          
          const disparar = () => {
            const cam = document.querySelector('[camera]');
            const bola = document.createElement('a-sphere');
            
            bola.setAttribute('radius', '0.15');
            bola.setAttribute('color', '#4CC3D9');
            // Physics attributes
            bola.setAttribute('dynamic-body', 'mass: 1; restitution: 0.7');
            
            // Start position: just in front of the camera
            const pos = cam.object3D.position;
            bola.setAttribute('position', `${pos.x} ${pos.y} ${pos.z - 0.5}`);

            // Direction calculation
            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(cam.object3D.quaternion);
            direction.multiplyScalar(20); 

            cena.appendChild(bola);

            // Apply velocity once the physics body is ready
            bola.addEventListener('body-loaded', () => {
              // We use CANNON.Vec3 for the physics engine
              const force = new CANNON.Vec3(direction.x, direction.y + 2, direction.z);
              bola.body.velocity.set(force.x, force.y, force.z);
            });

            // Cleanup
            setTimeout(() => { if(bola.parentNode) bola.parentNode.removeChild(bola); }, 4000);
          };

          window.addEventListener('keydown', (e) => { if(e.code === "Space") disparar(); });
          window.addEventListener('click', disparar);
        }
      });
    </script>
  </body>
</html>
