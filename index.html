<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Handball VR - Simulador Ajustado</title>
<script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
</head>

<body>
<a-scene shooter>

  <!-- Chão e céu -->
  <a-plane rotation="-90 0 0" width="20" height="20" color="#f58220"></a-plane>
  <a-sky color="#222"></a-sky>

  <!-- Score -->
  <a-text id="score" value="Score: 0" position="0 3 -5" align="center" width="8" color="white"></a-text>

  <!-- Barra de força -->
  <a-box id="power-bar" position="0 0.15 4.5" width="0.1" height="0.5" depth="0.1" color="lime" visible="false"></a-box>

  <!-- Som de golo -->
  <a-sound id="goal-sound" src="https://cdn.aframe.io/basic-guide/audio/boing.mp3" autoplay="false"></a-sound>

  <!-- Câmera PLAYER mais baixa -->
  <a-entity position="0 1.2 5">
    <a-camera>
      <a-cursor></a-cursor>
    </a-camera>
  </a-entity>

  <!-- Baliza -->
  <a-entity id="goal" position="0 0 -10">
    <a-box position="-1.5 1 0" width="0.1" height="2" depth="0.1" color="white"></a-box>
    <a-box position="1.5 1 0" width="0.1" height="2" depth="0.1" color="white"></a-box>
    <a-box position="0 2 0" width="3" height="0.1" depth="0.1" color="white"></a-box>
    <!-- Trigger invisível ajustado -->
    <a-box id="goal-trigger" position="0 1 -0.45" width="3" height="2" depth="0.6" visible="false" goal></a-box>
  </a-entity>

  <!-- Guarda-redes sólido -->
  <a-box id="keeper" position="0 1 -9.3" width="0.7" height="1.6" depth="0.3" color="red"
         keeper>
  </a-box>

</a-scene>

<script>
let score = 0;

// COMPONENTE GOLO
AFRAME.registerComponent('goal', {
  init() {
    this.el.addEventListener('check-collision', e => {
      const bola = e.detail.bola;
      if (!bola) return;

      const p = bola.object3D.position;
      const b = this.el.object3D;

      if (p.x > b.position.x - 1.5 && p.x < b.position.x + 1.5 &&
          p.y > b.position.y - 1 && p.y < b.position.y + 1 &&
          p.z > b.position.z - 0.25 && p.z < b.position.z + 0.25) { // trigger ajustado

        // Verifica colisão com guarda-redes
        const keeper = document.querySelector('#keeper');
        const kp = keeper.object3D.position;
        const kr = keeper.getAttribute('geometry');
        if (Math.abs(p.x - kp.x) < kr.width/2 && Math.abs(p.y - kp.y) < kr.height/2 &&
            Math.abs(p.z - kp.z) < kr.depth/2) {
          bola.remove();
          return;
        }

        score++;
        document.querySelector('#score').setAttribute('value', 'Score: ' + score);

        const sound = document.querySelector('#goal-sound');
        sound.components.sound.playSound();

        bola.remove();
      }
    });
  }
});

// GUARDA-REDES ANIMADO
AFRAME.registerComponent('keeper', {
  tick(time, delta) {
    const el = this.el;
    const pos = el.object3D.position;
    pos.x = Math.sin(time / 800) * 1.2; // movimento horizontal
  }
});

// SHOOTER COM FORÇA PROGRESSIVA
AFRAME.registerComponent('shooter', {
  init() {
    const scene = this.el;
    let power = 0;
    let charging = false;
    let interval;
    const maxPower = 1.5;

    const bar = document.querySelector('#power-bar');

    window.addEventListener('keydown', e => {
      if (e.code === 'Space' && !charging) {
        charging = true;
        power = 0;
        bar.setAttribute('visible', true);
        interval = setInterval(() => {
          power += 0.02;
          if (power > maxPower) power = maxPower;
          bar.setAttribute('scale', `${power / maxPower} 1 1`);
        }, 16);
      }
    });

    window.addEventListener('keyup', e => {
      if (e.code === 'Space' && charging) {
        charging = false;
        bar.setAttribute('visible', false);
        clearInterval(interval);

        const cam = document.querySelector('[camera]');
        const bola = document.createElement('a-sphere');
        bola.setAttribute('radius', 0.15);
        bola.setAttribute('color', '#4CC3D9');
        scene.appendChild(bola);

        const pos = new THREE.Vector3();
        cam.object3D.getWorldPosition(pos);
        bola.object3D.position.copy(pos);

        const dir = new THREE.Vector3(0,0,-1);
        dir.applyQuaternion(cam.object3D.quaternion);

        let velocity = { x: dir.x * 5 * power, y: dir.y * 5 * power + power*2, z: dir.z * 5 * power };
        bola.setAttribute('movement', { vel: velocity });

        // Checar colisão com baliza
        const goalTrigger = document.querySelector('#goal-trigger');
        const check = () => {
          if (!bola.parentNode) return;
          goalTrigger.emit('check-collision', { bola: bola });
          requestAnimationFrame(check);
        };
        check();

        setTimeout(() => {
          if (bola.parentNode) bola.parentNode.removeChild(bola);
        }, 5000);
      }
    });
  }
});

// MOVIMENTO DA BOLA (gravidade)
AFRAME.registerComponent('movement', {
  schema: { vel: { type: 'vec3' } },
  tick(time, delta) {
    const dt = delta / 1000;
    const v = this.data.vel;
    v.y -= 9.8 * dt;

    const p = this.el.object3D.position;
    p.x += v.x * dt;
    p.y += v.y * dt;
    p.z += v.z * dt;

    if (p.y < 0.2) {
      p.y = 0.2;
      v.y *= -0.5;
      v.x *= 0.8;
      v.z *= 0.8;
    }
  }
});
</script>
</body>
</html>
